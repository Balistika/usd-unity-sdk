#build_args:
#  no_python: --build-monolithic --alembic --no-python --no-imaging
#  full: --build-monolithic --alembic --openimageio
usd_versions:
  - version: v19.11
    dir_name: USD-19.11
  - version: v20.08
    dir_name: USD-20.08
  - version: v20.11
    dir_name: USD-20.11
usd_flavors:
  - name: minimal
    build_args:  --build-monolithic --alembic --no-imaging --no-examples --no-tutorials
    output_dir_suffix: ""
  - name: minimal, no python
    build_args: --build-monolithic --alembic --no-python --no-imaging --no-examples --no-tutorials
    output_dir_suffix: _no_python
build_platforms:
  - name: win
    type: Unity::VM
    image: filmtv/usd_build_win10_image:latest
    flavor: b1.large
    setenv_cmd: for /f "usebackq delims=#" %a in (`"%programfiles(x86)%\\Microsoft Visual Studio\\Installer\\vswhere" -latest -property installationPath`) do "%a\\Common7\\Tools\\VsDevCmd.bat"
    cmake_cmd: cmake -S .. -B . -DPXR_USD_LOCATION=C:/Users/bokken/libs/usd-v20.08_no_python -DPXR_USD_LOCATION_PYTHON_BUILT=C:/Users/bokken/libs/usd-v20.08_no_python -DUNITY_VERSION=2019.4 -DBUILD_USD_NET=TRUE -DBUILD_TESTS=TRUE -DCMAKE_MODULE_PATH=C:/Users/bokken/usd-unity-sdk/cmake/modules -G "NMake Makefiles"
    make_cmd: nmake SHELL=cmd install -j8
  - name: mac
    type: Unity::VM::osx
    image: filmtv/usd_build_macos_image:latest
    flavor: m1.mac
    setenv_cmd: echo "Environment set"
    cmake_cmd: cmake -S .. -B . -DPXR_USD_LOCATION=/home/bokken/libs/usd-v20.08_no_python -DPXR_USD_LOCATION_PYTHON_BUILT=/home/bokken/libs/usd-v20.08_no_python -DUNITY_VERSION=2019.4 -DBUILD_USD_NET=TRUE -DBUILD_TESTS=TRUE -DCMAKE_MODULE_PATH=/home/bokken/usd-unity-sdk/cmake/modules -G "Unix Makefiles"
    make_cmd: make install -j8
  - name: linux
    type: Unity::VM
    image: filmtv/usd_build_linux_image:latest
    flavor: b1.large
    setenv_cmd: echo "Environment set"
    cmake_cmd: cmake -S .. -B . -DPXR_USD_LOCATION=/home/bokken/libs/usd-v20.08_no_python -DPXR_USD_LOCATION_PYTHON_BUILT=/home/bokken/libs/usd-v20.08_no_python -DUNITY_VERSION=2019.4 -DBUILD_USD_NET=TRUE -DBUILD_TESTS=TRUE -DCMAKE_MODULE_PATH=/home/bokken/usd-unity-sdk/cmake/modules -G "Unix Makefiles"
    make_cmd: make install -j8
---

{% for platform in build_platforms %}
{% for usd_version in usd_versions %}
{% for usd_flavor in usd_flavors %}
{{usd_version.version}}_{{platform.name}}{{usd_flavor.output_dir_suffix}}:
  name: {{usd_version.version}} - {{platform.name}} - Build USD library ({{usd_flavor.name}})
  skip_checkout: true
  agent:
    type: {{platform.type}}
    image: {{platform.image}}
    flavor: {{platform.flavor}}
  commands:
    - |
      {{platform.setenv_cmd}}
      set PATH=%PATH%;C:\Program Files\CMake\bin
      wget https://github.com/PixarAnimationStudios/USD/archive/{{usd_version.version}}.zip
      unzip {{usd_version.version}}.zip
      cd {{usd_version.dir_name}}
      python build_scripts/build_usd.py --build-monolithic --alembic --no-python --no-imaging --no-examples --no-tutorials ../libs/usd-{{usd_version.version}}{{usd_flavor.output_dir_suffix}}
  artifacts:
      {{platform.name}}_{{usd_version.version}}_no_python:
        paths:
          - "../libs/usd-{{usd_version.version}}{{usd_flavor.output_dir_suffix}}/**"
{% endfor %}  
{% endfor %}  
{% endfor %}


{% for platform in build_platforms %}
{% for usd_version in usd_versions %}
{{platform.name}}_usd_v{{usd_version.version}}_bindings:
  name: {{usd_version.version}} - {{platform.name}} - Build C# bindings
  agent:
    type: {{platform.type}}
    image: {{platform.image}}
    flavor: {{platform.flavor}}
  commands:
    - |
        {{platform.setenv_cmd}}
        mkdir build
        cd build
        {{platform.cmake_cmd}}
        {{platform.make_cmd}}
  artifacts:
      {{platform.name}}_usdCs_v{{usd_version.version}}:
        paths:
          - "package/Runtime/Plugins/x86_64/{{platform.name}}/**"
{% endfor %}
{% endfor %}


{% for usd_version in usd_versions %}
{{usd_version.version}}_publish_bindings:
  name: {{usd_version.version}} - Publish C# bindings
  agent:
    type: linux
    image: filmtv/usd_build_linux_image:latest
    flavor: b1.small
  dependencies:
    - .yamato/build_usd.yml#win_usd_v{{usd_version.version}}_bindings
    - .yamato/build_usd.yml#mac_usd_v{{usd_version.version}}_bindings
    - .yamato/build_usd.yml#linux_usd_v{{usd_version.version}}_bindings
  commands:
    - bin/commit_bindings.sh
{% endfor %}